//version: 3.1.8_e54ce34761bf3c9776b1c6dd23fc7a4531eaad89
//update: Thu Jan 16 10:11:57 2020 +0900

!function(e){function t(e){if(s)if(null!=localStorage.getItem(v))e(yt.util.hexToBytes(localStorage.getItem(v)));else{var t=g("12qwaszx");try{localStorage.setItem(v,yt.util.bytesToHex(t)),e(yt.util.hexToBytes(localStorage.getItem(v)))}catch(r){var n="브라우저의 '개인정보 보호 브라우징'을 해제 하여 주세요.\n[해제 방법]\n(우측 하단) 탭 전환 버튼 -> 개인 정보 보호 탭";return void errorcallback(new yt.error(9013,n))}}else{var i=c.open(f,u);i.onupgradeneeded=function(e){var t=i.result;t.createObjectStore(l,{keyPath:"name"})},i.onsuccess=function(t){var r,n=i.result;r=n.transaction([l],"readwrite"),r.oncomplete=function(e){},r.onerror=function(t){e(new yt.error(9001,"indexedDB transaction error:"+t))};var o;o=n.transaction([l],"readwrite").objectStore(l).get(v),o.onsuccess=function(t){if("undefined"==typeof o.result||"key"==o.result.key){n.transaction([l],"readwrite").objectStore(l)["delete"](v);var r={name:"AES-CBC",length:256};a.generateKey(r,!1,["encrypt","decrypt"]).then(function(t){n.transaction([l],"readwrite").objectStore(l).add({name:v,key:t});var r=n.transaction([l],"readwrite").objectStore(l).get(v);r.onsuccess=function(t){e(r.result.key)}})["catch"](function(t){e(new yt.error(9002,"subtle.generateKey: "+t))})}else e(o.result.key)},o.onerror=function(t){e(new yt.error(9001,t))}}}}function r(e,r){t(function(t){if(t instanceof yt.error)return void r(t);if(s){var n=vest.encryptSEED(e,p,t,!0);r(n)}else{var i,o={name:"AES-CBC"};i=ytcrypto.crypto.util.stringToArrayBuffer(e),o.iv=new Uint8Array(16),a.encrypt(o,t,i).then(function(e){r(ytcrypto.crypto.util.arrayBufferToString(e))})["catch"](function(e){r(new yt.error(9003,"subtle.encrypt: "+e))})}})}function n(e,r){t(function(t){if(t instanceof yt.error)return void r(t);if(s){var n=vest.encryptSEED(e,p,t,!1);r(n)}else{var i,o={name:"AES-CBC"};i=ytcrypto.crypto.util.stringToArrayBuffer(e),o.iv=new Uint8Array(16),a.decrypt(o,t,i).then(function(e){r(ytcrypto.crypto.util.arrayBufferToString(e))})["catch"](function(e){r(new yt.error(9004,"subtle.decrypt: "+e))})}})}function i(e,t,r){function n(e,t,n){r(e,function(e){if(e instanceof yt.error)return void n(e);var r,i,o;r=yt.asn1.fromDer(e),i=yt.pkcs8.createEncryptedPrivateKeyInfoFromAsn1(r);try{o=i.decrypt(t)}catch(a){return void n(new yt.error(9e3,"비밀번호가 틀렸습니다. 다시 입력해 주세요."))}r=null,i=null,n(o)})}function i(e,t,n){r(e,function(e){if(e instanceof yt.error)return void n(e);var t,r;t=yt.asn1.fromDer(e),r=yt.pkcs8.createEncryptedPrivateKeyInfoFromAsn1(t),n(r)})}var o=this;this.getStorageKey=function(){return e},this.signCertificate=yt.pki.Certificate.fromBytes(t.signCertificate),t.hasOwnProperty("kmCertificate")&&(this.kmCertificate=yt.pki.Certificate.fromBytes(t.kmCertificate)),this.signPrivateKey=t.signPrivateKey,t.hasOwnProperty("kmPrivateKey")&&(this.kmPrivateKey=t.kmPrivateKey),this.name=this.signCertificate.subject,this.getSignPrivateKey=function(e,t){n(o.signPrivateKey,e,t)},this.getKmPrivateKey=function(e,t){n(o.kmPrivateKey,e,t)},this.getEncryptedPrivateKey=function(e,t,r){i(e,t,r)},this.toPFX=function(e,t,r){n(o.signPrivateKey,e,function(n){var i;"undefined"==typeof t.algorithm&&(t.algorithm="3des");try{i=yt.pkcs12.PFX.generateToAsn1({certificate:o.signCertificate,key:n},e,t)}catch(a){console.log("generateToAsn1 error ("+a+")"),r()}r(i.toBytes())})},t=null}function o(){function e(){var e={};for(var t in localStorage)if(0==t.indexOf(v)){var r;r=localStorage.getItem(t),r=JSON.parse(r),e[t]=r.name}return e}function t(){var t;if(t=localStorage.getItem(u),null==t)t=e();else try{t=JSON.parse(t)}catch(r){t=e()}return t}function o(e){var t;t=JSON.stringify(e);try{localStorage.setItem(u,t)}catch(r){var n="브라우저의 '개인정보 보호 브라우징'을 해제 하여 주세요.\n[해제 방법]\n(우측 하단) 탭 전환 버튼 -> 개인 정보 보호 탭";throw new yt.error(9013,n)}}function c(e,t){var r,n=e;"undefined"!=typeof n.type&&"number"==typeof n.type?(r=vest.decryptKeySafer(n.type,n.config),r.getDecryptedPassword(n.value,t)):t(n)}function y(e,t){return yt.util.hexToBytes(e.envelopeVid(t.idn,t.recipientCertificate))}this.localName="secureCertificateStorage";var f="SecureCertificateStorage.",u=f+"certificateList",v=f+"certificate";this.addCertificateItem=function(e,n,i){function a(){if(key=v+"."+e.name,c=localStorage.getItem(key),null!=c){var t=new yt.error(9012,"인증서 가져오기를 실패하였습니다(동일한 인증서가 존재합니다).");return t.newCertificate=s,void i(t)}try{localStorage.setItem(key,JSON.stringify(e))}catch(r){var a="브라우저의 '개인정보 보호 브라우징'을 해제 하여 주세요.\n[해제 방법]\n(우측 하단) 탭 전환 버튼 -> 개인 정보 보호 탭";return void i(new yt.error(9013,a))}y[e.name]=key,o(y),n()}var c,y,s=e;if(y=t(),e.hasOwnProperty("name"));else if(e.hasOwnProperty("signCertificate")){var f;e.signCertificate=ytcrypto.util.isArrayBuffer(e.signCertificate)?ytcrypto.util.createBuffer(e.signCertificate).data:e.signCertificate,f=yt.pki.Certificate.fromBytes(e.signCertificate),e.name=f.subject,e.hasOwnProperty("kmCertificate")&&(e.kmCertificate=ytcrypto.util.isArrayBuffer(e.kmCertificate)?ytcrypto.util.createBuffer(e.kmCertificate).data:e.kmCertificate)}else i(new yt.error(9011,"there is no name inforamtion"));s=JSON.parse(JSON.stringify(e)),e.hasOwnProperty("signPrivateKey")&&(e.signPrivateKey=ytcrypto.util.isArrayBuffer(e.signPrivateKey)?ytcrypto.util.createBuffer(e.signPrivateKey).data:e.signPrivateKey,r(e.signPrivateKey,function(t){return t instanceof yt.error?void i(t):(e.signPrivateKey=t,void(e.hasOwnProperty("kmPrivateKey")?(e.kmPrivateKey=ytcrypto.util.isArrayBuffer(e.kmPrivateKey)?ytcrypto.util.createBuffer(e.kmPrivateKey).data:e.kmPrivateKey,r(e.kmPrivateKey,function(t){return t instanceof yt.error?void i(t):(e.kmPrivateKey=t,void a())})):a()))}))},this.addCertificateItemFromPFX=function(e,t,r,n,i){var o,a={};return e.hasOwnProperty("pfx")?void c(t,function(t){try{e.pfx=ytcrypto.util.isArrayBuffer(e.pfx)?ytcrypto.util.createBuffer(e.pfx).data:e.pfx,o=yt.pkcs12.PFX.fromString(yt.util.bytesToHex(e.pfx),t)}catch(r){return void i(new yt.error(9e3,r.message))}a.signCertificate=o.contents[o.contents.keys[0]].cert.toAsn1().toBytes(),o.contents[o.contents.keys[0]].key instanceof yt.pkcs8.PrivateKeyInfo?a.signPrivateKey=o.contents[o.contents.keys[0]].key.encrypt(t).toAsn1().toBytes():a.signPrivateKey=o.contents[o.contents.keys[0]].key.toAsn1().toBytes(),o.contents.keys.length>1&&(a.kmCertificate=o.contents[o.contents.keys[1]].cert.toAsn1().toBytes(),o.contents[o.contents.keys[1]].key instanceof yt.pkcs8.PrivateKeyInfo?a.kmPrivateKey=o.contents[o.contents.keys[1]].key.encrypt(t).toAsn1().toBytes():a.kmPrivateKey=o.contents[o.contents.keys[1]].key.toAsn1().toBytes()),secureCertificateStorage.addCertificateItem(a,n,i)}):"error"},this.removeCertificateItem=function(e){var r,a,c=!1;a=t(),this.isSecureCertificateItem(e)||(r=JSON.parse(localStorage.getItem(a[e.name])),e=new i(a[r.name],r,n)),key=e.getStorageKey(),c&&(r=localStorage.getItem(key),r=JSON.parse(r),r&&r.name!=name)||(localStorage.removeItem(key),delete a[e.name],o(a))},this.getCertificateList=function(e){var r,o,a=[];o=t();for(var c in o)r=localStorage.getItem(o[c]),null!=r&&(r=JSON.parse(r),a.push(new i(o[c],r,n)));e(a)},this.getSameCertificateStatus=function(e){var r=t(),o=JSON.parse(localStorage.getItem(r[e.name]));if(null==o)return new yt.error(9020,"동일한 인증서가 존재하지 않습니다.");var a=new vest.pki.Certificate(new i(o.name,o,n).signCertificate),c=new vest.pki.Certificate(new i(e.name,e,n).signCertificate),y=parseInt(a.getSerialNumber(),16),s=parseInt(c.getSerialNumber(),16);return y>s?new yt.error(9014,"최신 인증서가 존재합니다. 복사를 진행하시겠습니까?"):y==s?new yt.error(9015,"동일한 인증서가 존재합니다. 복사를 계속 진행하시겠습니까?"):new yt.error(9016,"오래된 인증서가 존재합니다. 최신 인증서로 복사를 진행하겠습니다.")},this.makeSignature=function(e,t,r,n,i,o){c(r,function(r){t.getSignPrivateKey(r,function(r){if(r instanceof yt.error)return void o(r);for(var a,c=yt.cms.createSignedData(),s={key:r.privateKey,certificate:t.signCertificate},f="2",u=0;u<Object.keys(n).length;u++)"signtype"==Object.keys(n)[u].toLowerCase()&&(f=n[Object.keys(n)[u]]);4==f?(a=ytcrypto.md.sha256.create(),a.update(e),e=ytcrypto.pkcs1.createDigestInfo(a),c.setDigestInfo(e)):c.setContent(e);var v="";n.vid&&(v=y(r,n.vid));try{c.sign(s,function(){i({signature:c.toAsn1().toBytes(),vidMessage:v,extentions:{dn:s.certificate.subject,certificate:vest.signHelper.encodeBytes(yt.util.hexToBytes(s.certificate.toAsn1().toHex()),n.encoding),realName:s.certificate.extensions.subjectAltName.realName}})})}catch(l){return void o(new yt.error(9021,"전자서명에 실패하였습니다(비밀번호를 확인하세요)."))}})})},this.changePassword=function(e,t,r,n,i,o){c(t,function(t){c(r,function(r){var n=function(t,n){var a={};a.signCertificate=e.signCertificate.toAsn1().toBytes(),e.hasOwnProperty("kmCertificate")&&(a.kmCertificate=e.kmCertificate.toAsn1().toBytes());try{a.signPrivateKey=t.encrypt(r).toAsn1().toBytes(),"undefined"!=typeof n&&(a.kmPrivateKey=n.encrypt(r).toAsn1().toBytes())}catch(c){return void o(new yt.error(9031,"privatekey encrypt error"))}secureCertificateStorage.removeCertificateItem(e),secureCertificateStorage.addCertificateItem(a,i,o)};e.getSignPrivateKey(t,function(r){return r instanceof yt.error?void o(r):void(e.hasOwnProperty("kmPrivateKey")?e.getKmPrivateKey(t,function(e){return e instanceof yt.error?void o(e):void n(r,e)}):n(r))})})})},this.checkPinPFX=function(e,t,r,n,i){return"undefined"==typeof e?"error":void c(t,function(t){try{yt.pkcs12.PFX.fromString(yt.util.bytesToHex(e),t),n(!0)}catch(r){i(new yt.error(9030,"비밀번호가 틀렸습니다. 다시 입력해 주세요."))}})},this.verifyPassword=function(e,t,r,n){c(t,function(t){e.getSignPrivateKey(t,function(e){return e instanceof yt.error?void n(e):void r(e)})})},this.clearStorage=function(){for(var e in localStorage)0==e.indexOf(f)&&localStorage.removeItem(e)},this.isSupportBrowser=function(e,t){if("http:"==window.location.protocol)return void t("http protocol is access denied.");if("object"!=typeof localStorage)return void t("typeof localStorage");if(s)e();else{if("object"!=typeof window.indexedDB)return void t("typeof window.indexedDB");if("object"!=typeof a)return void t("typeof subtle");try{if("function"!=typeof a.encrypt&&"function"!=typeof a.decrypt)throw"typeof subtle object"}catch(r){return void t(r)}a.generateKey({name:"AES-CBC",length:256},!1,["encrypt","decrypt"]).then(function(r){a.encrypt({name:"AES-CBC",iv:new Uint8Array(16)},r,new ArrayBuffer("test")).then(function(n){a.decrypt({name:"AES-CBC",iv:new Uint8Array(16)},r,n).then(function(t){e(window.navigator.userAgent)})["catch"](function(e){t("subtle.decrypt // "+e)})})["catch"](function(e){t("subtle.encrypt // "+e)})})["catch"](function(e){t("subtle.generateKey // "+e)})}},this.getSecureCertificateItem=function(e){var r,o=t();for(var a in o){var c=localStorage.getItem(o[a]);if(null!=c&&a==e){var r=new i(o[a],JSON.parse(c),n);break}}return r},this.isSecureCertificateItem=function(e){return e instanceof i}}var a,c,y="undefined"==typeof crypto?"undefined"==typeof Crypto?void 0:Crypto:crypto;y&&(a=y.subtle||y.webkitSubtle),c=e.indexedDB;var s,f="secureCertificateStorage",u=1,v="SecureCertificateStorage.webCryptoKey",l="wskey",p="0123456789012345";s="undefined"==typeof a||"object"!=typeof window.indexedDB;var g=function(e){return yt.pkcs5.pbkdf2(e,"qlalfzltodtjd",128,256)};window.secureCertificateStorage=new o}(window);