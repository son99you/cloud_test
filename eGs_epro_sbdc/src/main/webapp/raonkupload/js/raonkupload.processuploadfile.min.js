var G_LoadSecurityJs=!1,G_LoadCompressJs=!1,G_LoadCryptoJs=!1;importScripts("raonkupload.base64.js");importScripts("raonkupload.xhr.js");var G_formfeed="\f",G_vertical="\x0B",G_xhr=null,CryptoJS=null;function makeGuidTagName(a){var b=0,e=(new Date).getTime().toString(32),f;for(f=0;5>f;f++)e+=Math.floor(65535*Math.random()).toString(32);return(a||"o_")+e+(b++).toString(32)}
function upload(a){"1"!=a.security.fileEncrypt&&"2"!=a.security.fileEncrypt&&"2"!=a.security.encryptParam||null!=CryptoJS||importScripts("aes.js");if(null==G_xhr||void 0==G_xhr)G_xhr=new XMLHttpRequest;var b=a.handlerUrl,b=-1<b.indexOf("?")?b+("&raonk="+makeGuidTagName("urk_")):b+("?raonk="+makeGuidTagName("urk_"));G_xhr.open("POST",b,a.asyncUpload);var e=a.chunk.size;try{G_xhr.upload.onprogress=function(d){d=parseInt(d.loaded/d.total*a.chunk.size*1,10);self.postMessage({type:"chunkProgress",chunkLoadedSize:d})}}catch(f){}G_xhr.onreadystatechange=
function(){if(4==G_xhr.readyState)if(200==G_xhr.status){var d=RaonKBase64.parseDataFromServer(G_xhr.responseText);if("[OK]"==d)self.postMessage({type:"progress",paramObj:{uploadedSize:e,workerId:a.workerId,uploadIdx:a.uploadIdx,path:a.path}});else if(0==d.indexOf("[FAIL]")){var d=d.replace("[FAIL]",""),d=RaonKBase64.makeDecryptReponseMessage(d,a.security),d=d.split("|"),b="",c="";0==d.length?c=d[0]:(b=d[0],c=d[1]);self.postMessage({type:"error",code:b,message:c,id:a.id});G_xhr=void 0;self.close()}}else 400<=
G_xhr.status&&600>G_xhr.status&&(d=G_xhr.responseText,d=d.replace("[FAIL]",""),d=RaonKBase64.makeDecryptReponseMessage(d,a.security),d=d.split("|"),b="",0==d.length?c=d[0]:(b=d[0],c=d[1]),self.postMessage({type:"error",code:b,message:c,id:a.id}),G_xhr=void 0,self.close())};var c="",k=function(){try{G_xhr.send(c),c=void 0}catch(d){self.postMessage({type:"error",code:"C000",message:d.message,workerId:a.workerId}),G_xhr=void 0}},b=""+("kc"+G_formfeed+"c02"+G_vertical),b=b+("k01"+G_formfeed+a.security.encryptParam+
G_vertical);0<a.security.fileEncrypt&&(b+="k02"+G_formfeed+a.security.fileEncrypt+G_vertical);b+="k03"+G_formfeed+a.security.fileIntegrity+G_vertical;"0"!=a.compress&&(b+="k04"+G_formfeed+3+G_vertical);b+="k05"+G_formfeed+a.resumeUpload+G_vertical;b+="k12"+G_formfeed+a.guid+G_vertical;b+="k19"+G_formfeed+a.startPos+G_vertical;b+="k26"+G_formfeed+a.path;"1"==a.useKMonitoring&&(b+=G_vertical+"km0"+G_formfeed+a.trasnferId+G_vertical,b+="km3"+G_formfeed+a.previousUploadSize+G_vertical);b=RaonKBase64.makeEncryptParamFinal(a.security,
b);if("undefined"==typeof FormData){var h=makeGuidTagName("----raonk_"),g=function(a){G_xhr&&(G_xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+h),G_xhr.setRequestHeader("RAONK-Encoded","base64"));c=a;k()};try{buildFormData(a,b,h,g)}catch(m){self.postMessage({type:"error",code:"C001",message:m.message,workerId:a.workerId}),G_xhr=void 0}}else{c=new FormData;c.append(b.name,b.value);var l;if("1"==a.security.fileIntegrity||"0"!=a.compress||"0"!=a.security.fileEncrypt)l=new FileReaderSync,
g=l.readAsArrayBuffer(a.chunk),l=void 0;b="";"1"==a.security.fileIntegrity&&(G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0),b=D5FileDataIntegrity(g,a.security.keyValue,!0).toString(),c.append("k25",b));var n=function(a){c.append("Slice",a);k()};"0"!=a.compress?makeZipData(a.uploadIdx,g,function(d){0<a.security.fileEncrypt?(l=new FileReaderSync,newData=l.readAsArrayBuffer(d),l=void 0,encryptFileData(newData,a.security.keyValue,16*a.security.fileEncrypt,
n)):(c.append("Slice",d),k())}):0<a.security.fileEncrypt?encryptFileData(g,a.security.keyValue,16*a.security.fileEncrypt,n):(c.append("Slice",a.chunk),k())}}self.onmessage=function(a){a=a.data;switch(a.type){case "upload":upload(a.uploadData);break;case "check_formdata":a=!0,"undefined"==typeof FormData&&(a=!1),self.postMessage({type:"check_formdata",isFormDataSupport:a})}};
function buildFormData(a,b,e,f){var c=new FileReaderSync,k=c.readAsDataURL(a.chunk),h=k.match(/,(.*)$/)[1],g,m,l=function(){var a;a=""+("--"+e+'\r\nContent-Disposition: form-data; name="'+b.name+'"');a+="\r\n\r\n";a+=b.value;a+="\r\n";a+="--"+e+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream; charset=UTF-8";a+="\r\n";a+="\r\n";a+=h;a+="\r\n";m&&(a+="--"+e+'\r\nContent-Disposition: form-data; name="k25"',a+="\r\n",a+="\r\n",a+=
m,a+="\r\n");a+="--"+e+"--\r\n";c=k=h=void 0;f(a)};"1"==a.security.fileIntegrity&&(G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0),g=c.readAsArrayBuffer(a.chunk),m=D5FileDataIntegrity(g,a.security.keyValue,!0).toString());var n=function(a){h=c.readAsDataURL(a).match(/,(.*)$/)[1];l()};"0"!=a.compress?(g||(g=c.readAsArrayBuffer(a.chunk)),makeZipData(a.uploadIdx,g,function(b){0<a.security.fileEncrypt?encryptFileData(c.readAsArrayBuffer(b),
a.security.keyValue,16*a.security.fileEncrypt,n):(h=c.readAsDataURL(b).match(/,(.*)$/)[1],l())})):0<a.security.fileEncrypt?(g||(g=c.readAsArrayBuffer(a.chunk)),encryptFileData(g,a.security.keyValue,16*a.security.fileEncrypt,n)):l()}
function makeZipData(a,b,e){G_LoadCompressJs||(importScripts("jszip/jszip.js"),G_LoadCompressJs=!0);var f=new JSZip;f.file(a,b);f.generateAsync({type:"blob",compression:"deflate",compressionOptions:{level:9},comment:"RAONWIZ"},function(a){}).then(function(a){"function"==typeof e&&e(a);f=void 0})}
function encryptFileData(a,b,e,f){var c=crypto||msCrypto;if(c&&c.subtle){var k=stringToBytes(b);b=new Uint8Array(e);b.set(k);var h=c.subtle.importKey("raw",b,{name:"AES-CBC"},!1,["encrypt","decrypt"]);h.then(function(b){var e=new Uint8Array(16);e.set(k);c.subtle.encrypt({name:"AES-CBC",iv:e},b,a).then(function(a){a=makeBlob(a);f(a)})["catch"]=function(a){self.postMessage({type:"error",code:"C011",message:a.message||a,workerId:workerData.workerId})}})["catch"]=function(a){self.postMessage({type:"error",
code:"C011",message:a.message||a,workerId:workerData.workerId})}}else G_LoadCryptoJs||(G_LoadSecurityJs||importScripts("raonkupload.fdi.aes.js"),G_LoadCryptoJs=!0),h=CryptoJS.enc.Utf8.parse(b),h.sigBytes=e,wordArrayData=arrayBufferToWordArray(a),b=CryptoJS.AES.encrypt(wordArrayData,h,{iv:CryptoJS.enc.Utf8.parse(b)}),wordArrayData=void 0,b=makeBlob(convertWordArrayToUint8Array(b.ciphertext)),f(b)}
function arrayBufferToBase64(a){var b="";a=new Uint8Array(a);for(var e=a.byteLength,f=0;f<e;f++)b+=String.fromCharCode(a[f]);return btoa(b)}function stringToBytes(a){for(var b,e,f=[],c=0;c<a.length;c++){b=a.charCodeAt(c);e=[];do e.push(b&255),b>>=8;while(b);f=f.concat(e.reverse())}return f}var makeBlob=function(a){var b=[];b.push(a);return new Blob(b,{type:"application/octet-stream"})};
